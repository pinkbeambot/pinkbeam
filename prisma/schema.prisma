generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String          @id @default(cuid())
  email               String          @unique
  name                String?
  role                UserRole        @default(CLIENT)
  phone               String?
  company             String?
  website             String?
  companySize         String?
  industry            String?
  servicesNeeded      String[]
  onboardingCompleted Boolean         @default(false)
  onboardingStep      String          @default("profile")
  onboardingStartedAt DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  lastLoginAt         DateTime?
  projects            Project[]
  quotes              Quote[]
  invoices            Invoice[]
  tickets             SupportTicket[] @relation("TicketClient")
  assignedTickets     SupportTicket[] @relation("TicketAssignee")
  ticketComments      TicketComment[]
  files               File[]
  projectMemberships  ProjectMember[]
  assignedTasks       Task[]          @relation("AssignedTasks")
  createdTasks        Task[]          @relation("CreatedTasks")
  timeEntries         TimeEntry[]
  workloadEntries     WorkloadEntry[]
  capacityConfig      UserCapacity?
  subscriptions       Subscription[]
  searchVector        String?         @map("search_vector")

  @@index([searchVector(ops: raw("gin_trgm_ops"))], type: Gin)
  @@map("users")
}

model Project {
  id           String        @id @default(cuid())
  title        String
  description  String?
  status       ProjectStatus @default(LEAD)
  clientId     String
  services     ServiceType[]
  budget       Decimal?      @db.Decimal(10, 2)
  deadline     DateTime?
  startDate    DateTime?
  targetEndDate DateTime?
  completedAt  DateTime?
  progress     Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invoices     Invoice[]
  client       User          @relation(fields: [clientId], references: [id])
  quotes       Quote[]
  files        File[]
  members      ProjectMember[]
  milestones   ProjectMilestone[]
  updates      ProjectUpdate[]
  tasks        Task[]
  timeEntries  TimeEntry[]
  sprints      Sprint[]
  workloadEntries WorkloadEntry[]
  searchVector String?       @map("search_vector")

  @@index([clientId])
  @@index([status])
  @@index([clientId, status])
  @@index([deadline])
  @@index([createdAt])
  @@index([searchVector(ops: raw("gin_trgm_ops"))], type: Gin)
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("MEMBER")
  joinedAt  DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model ProjectMilestone {
  id          String    @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, order])
  @@map("project_milestones")
}

enum ProjectUpdateType {
  STATUS_CHANGE
  MILESTONE
  DELIVERABLE
  NOTE
  BLOCKER
}

model ProjectUpdate {
  id            String            @id @default(cuid())
  projectId     String
  authorId      String
  type          ProjectUpdateType @default(NOTE)
  title         String
  body          String?
  visible       Boolean           @default(true) // client-visible or internal-only
  readBy        String[]          @default([]) // User IDs who have read this update
  attachments   Json?             // File references {id, name, url}[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, createdAt])
  @@index([visible])
  @@map("project_updates")
}

model Quote {
  id          String      @id @default(cuid())
  quoteNumber String      @unique
  projectId   String?
  clientId    String
  title       String
  description String?
  status      QuoteStatus @default(DRAFT)
  subtotal    Decimal     @db.Decimal(10, 2)
  taxRate     Decimal?    @db.Decimal(5, 2)
  taxAmount   Decimal?    @db.Decimal(10, 2)
  total       Decimal     @db.Decimal(10, 2)
  validUntil  DateTime?
  notes       String?
  terms       String?
  createdById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  sentAt      DateTime?
  acceptedAt  DateTime?
  declinedAt  DateTime?
  declinedReason String?

  project     Project?    @relation(fields: [projectId], references: [id])
  client      User        @relation(fields: [clientId], references: [id])
  lineItems   QuoteLineItem[]

  @@index([clientId])
  @@index([status])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(cuid())
  quoteId     String
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  quote       Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_line_items")
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  projectId     String?
  clientId      String
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  paidAt        DateTime?
  subtotal      Decimal       @db.Decimal(10, 2)
  taxRate       Decimal?      @db.Decimal(5, 2)
  taxAmount     Decimal?      @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  amountPaid    Decimal       @default(0) @db.Decimal(10, 2)
  amountDue     Decimal       @db.Decimal(10, 2)
  notes         String?
  terms         String        @default("Net 30")
  sentAt        DateTime?
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  project       Project?      @relation(fields: [projectId], references: [id])
  client        User          @relation(fields: [clientId], references: [id])
  lineItems     InvoiceLineItem[]
  payments      Payment[]
  files         File[]

  @@index([clientId])
  @@index([status])
  @@index([clientId, status])
  @@index([dueDate])
  @@index([createdAt])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)
  timeEntryId String?

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
}

model Payment {
  id                    String   @id @default(cuid())
  invoiceId             String
  amount                Decimal  @db.Decimal(10, 2)
  method                String   // cash, check, transfer, stripe
  reference             String?
  notes                 String?
  paidAt                DateTime @default(now())
  recordedById          String

  // Stripe integration
  stripePaymentIntentId String?  @unique
  stripeInvoiceId       String?

  invoice               Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CLIENT
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  GENERAL
  BUG
  FEATURE_REQUEST
  BILLING
  TECHNICAL
}

model SupportTicket {
  id            String          @id @default(cuid())
  clientId      String
  assigneeId    String?
  projectId     String?
  title         String
  description   String
  status        TicketStatus    @default(OPEN)
  priority      TicketPriority  @default(MEDIUM)
  category      TicketCategory  @default(GENERAL)
  slaDeadline   DateTime?
  slaBreach     Boolean         @default(false)
  slaBreachedAt DateTime?
  resolvedAt    DateTime?
  closedAt      DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  client        User            @relation("TicketClient", fields: [clientId], references: [id])
  assignee      User?           @relation("TicketAssignee", fields: [assigneeId], references: [id])
  comments      TicketComment[]
  files         File[]
  searchVector  String?         @map("search_vector")

  @@index([clientId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([status, priority])
  @@index([slaDeadline])
  @@index([searchVector(ops: raw("gin_trgm_ops"))], type: Gin)
  @@map("support_tickets")
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  authorId   String
  body       String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author     User          @relation(fields: [authorId], references: [id])
  files      File[]

  @@index([ticketId])
  @@map("ticket_comments")
}

enum BlogCategory {
  AI_STRATEGY
  DIGITAL_TRANSFORMATION
  PROCESS_AUTOMATION
  TECHNOLOGY_ARCHITECTURE
  LEADERSHIP
  CASE_STUDY
  INDUSTRY_INSIGHTS
}

enum BlogService {
  WEB
  LABS
  SOLUTIONS
  AGENTS
}

model BlogPost {
  id           String        @id @default(cuid())
  title        String
  slug         String
  excerpt      String?
  content      String
  metaTitle    String?
  metaDesc     String?
  published    Boolean       @default(false)
  publishedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  searchVector String?       @map("search_vector")

  // Solutions-specific fields
  category     BlogCategory?
  service      BlogService   @default(WEB)
  featured     Boolean       @default(false)
  readingTime  Int?          // in minutes
  authorName   String        @default("Pink Beam Team")
  authorTitle  String?
  authorAvatar String?
  featuredImage String?
  tags         String[]      @default([])

  @@unique([slug, service])
  @@index([searchVector(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([service, published])
  @@index([service, category])
  @@index([service, featured])
  @@index([publishedAt])
  @@map("blog_posts")
}

model File {
  id           String         @id @default(cuid())
  name         String
  storagePath  String
  bucket       String
  mimeType     String
  size         Int
  uploadedById String
  projectId    String?
  ticketId     String?
  commentId    String?
  invoiceId    String?
  width        Int?
  height       Int?
  alt          String?
  versionGroupId String?
  version      Int           @default(1)
  isLatest     Boolean       @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  uploadedBy   User           @relation(fields: [uploadedById], references: [id])
  project      Project?       @relation(fields: [projectId], references: [id])
  ticket       SupportTicket? @relation(fields: [ticketId], references: [id])
  comment      TicketComment? @relation(fields: [commentId], references: [id])
  invoice      Invoice?       @relation(fields: [invoiceId], references: [id])

  @@index([uploadedById])
  @@index([projectId])
  @@index([ticketId])
  @@index([versionGroupId])
  @@index([versionGroupId, isLatest])
  @@unique([versionGroupId, version])
  @@map("files")
}

model ActivityLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String?
  userId     String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@map("activity_logs")
}

enum NotificationType {
  PROJECT_UPDATE
  QUOTE_STATUS
  TICKET_REPLY
  INVOICE_CREATED
  FILE_SHARED
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional context
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

enum UserRole {
  ADMIN
  MANAGER
  CLIENT
}

enum ProjectStatus {
  LEAD
  QUOTED
  ACCEPTED
  IN_PROGRESS
  REVIEW
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ServiceType {
  DESIGN
  DEVELOPMENT
  SEO
  MAINTENANCE
  CONSULTING
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum QuoteRequestStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  ACCEPTED
  DECLINED
}

// Task/Issue Tracking Models
model Task {
  id          String       @id @default(cuid())
  projectId   String
  sprintId    String?
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  type        TaskType     @default(FEATURE)
  assigneeId  String?
  createdById String
  dueDate     DateTime?
  estimate    Int?         // Hours
  storyPoints Int?         // Story points for sprint planning
  order       Int          @default(0) // Backlog order
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint      Sprint?      @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee    User?        @relation(fields: [assigneeId], references: [id], name: "AssignedTasks")
  createdBy   User         @relation(fields: [createdById], references: [id], name: "CreatedTasks")
  labels      TaskLabel[]
  timeEntries TimeEntry[]
  workloadEntries WorkloadEntry[]

  @@index([projectId])
  @@index([sprintId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([projectId, status])
  @@index([projectId, sprintId])
  @@index([dueDate])
  @@index([order])
  @@map("tasks")
}

model TaskLabel {
  id        String   @id @default(cuid())
  name      String
  color     String   // Hex color code
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]

  @@unique([name])
  @@map("task_labels")
}

model TimeEntry {
  id          String   @id @default(cuid())
  projectId   String
  taskId      String?
  userId      String
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int      // Minutes
  billable    Boolean  @default(true)
  invoiced    Boolean  @default(false)
  invoiceId   String?
  hourlyRate  Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([taskId])
  @@index([startTime])
  @@index([userId, startTime])
  @@index([projectId, startTime])
  @@index([invoiced])
  @@index([invoiceId])
  @@map("time_entries")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  FEATURE
  BUG
  CHORE
  DOCUMENTATION
}

// Sprint/Iteration Planning Models
enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

model Sprint {
  id              String       @id @default(cuid())
  projectId       String
  name            String
  goal            String?
  startDate       DateTime
  endDate         DateTime
  status          SprintStatus @default(PLANNING)
  totalPoints     Int          @default(0)
  completedPoints Int          @default(0)
  reviewNotes     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]
  burndownData SprintBurndownData[]

  @@index([projectId])
  @@index([status])
  @@index([projectId, status])
  @@map("sprints")
}

model SprintBurndownData {
  id        String   @id @default(cuid())
  sprintId  String
  date      DateTime
  remainingPoints Int
  completedPoints Int
  createdAt DateTime @default(now())

  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@unique([sprintId, date])
  @@index([sprintId])
  @@index([sprintId, date])
  @@map("sprint_burndown_data")
}

model QuoteRequest {
  id               String              @id @default(cuid())
  fullName         String
  email            String
  phone            String?
  company          String?
  website          String?
  projectType      String
  services         String[]
  pageCount        String?
  needsEcommerce   Boolean             @default(false)
  cmsPreference    String?
  budgetRange      String
  timeline         String
  description      String
  referralSource   String?
  marketingConsent Boolean             @default(false)
  status           QuoteRequestStatus  @default(NEW)
  notes            String?
  estimatedAmount  Decimal?            @db.Decimal(10, 2)
  leadScore        Int                 @default(0)
  leadQuality      String?             // "hot", "warm", "cold"
  followUpStage    Int                 @default(0)  // 0=none, 1=day1, 2=day3, 3=day7
  lastFollowUpAt   DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([status])
  @@index([email])
  @@index([status, createdAt])
  @@index([leadScore])
  @@map("quote_requests")
}

model DemoRequest {
  id            String   @id @default(cuid())
  email         String
  employeeType  String
  competitors   String[]
  focusAreas    String[]
  briefData     Json?
  emailSent     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([createdAt])
  @@index([email, createdAt])
  @@map("demo_requests")
}

model WebhookEvent {
  id          String   @id
  source      String   // 'stripe', 'github', etc.
  eventType   String
  payload     Json
  processed   Boolean  @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime @default(now())

  @@index([source, eventType])
  @@index([processed])
  @@index([createdAt])
  @@index([source, processed, createdAt])
  @@map("webhook_events")
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  type      String   // 'pageview', 'event'
  name      String   // event name or page URL
  path      String?  // page path
  referrer  String?
  userAgent String?
  ipHash    String?  // hashed IP for privacy
  userId    String?  // if authenticated
  metadata  Json?    // additional properties
  createdAt DateTime @default(now())

  @@index([type, name])
  @@index([createdAt])
  @@map("analytics_events")
}

model CaseStudy {
  id                String   @id @default(cuid())
  slug              String   @unique
  title             String
  clientName        String
  industry          String
  isAnonymous       Boolean  @default(false)
  challenge         String
  solution          String
  results           String
  metrics           Json     // { label: string, value: string }[]
  services          String[]
  engagementType    String
  testimonial       String?
  testimonialAuthor String?
  testimonialTitle  String?
  published         Boolean  @default(false)
  featured          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("case_studies")
}

enum ResourceType {
  TEMPLATE
  FRAMEWORK
  CHECKLIST
  CALCULATOR
  REPORT
  TOOL
}

model Resource {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String
  type        ResourceType
  category    String
  topics      String[]
  fileUrl     String
  fileFormat  String
  fileSize    String
  isGated     Boolean  @default(true)
  downloadCount Int    @default(0)
  published   Boolean  @default(false)
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  downloads   ResourceDownload[]

  @@map("resources")
}

model ResourceDownload {
  id           String   @id @default(cuid())
  resourceId   String
  email        String
  name         String
  company      String?
  role         String?
  downloadedAt DateTime @default(now())

  resource     Resource @relation(fields: [resourceId], references: [id])

  @@index([resourceId])
  @@map("resource_downloads")
}

// Workload Management Models
model WorkloadEntry {
  id             String   @id @default(cuid())
  userId         String
  projectId      String
  taskId         String?
  date           DateTime
  allocatedHours Float
  actualHours    Float?
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task           Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  @@index([userId, date])
  @@index([projectId])
  @@index([taskId])
  @@map("workload_entries")
}

model UserCapacity {
  id              String   @id @default(cuid())
  userId          String   @unique
  defaultCapacity Float    @default(8.0)  // Default daily hours
  workDays        String[] @default(["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"])
  effectiveFrom   DateTime @default(now())
  effectiveTo     DateTime?

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_capacities")
}

// Subscription & Billing Models

enum PlanServiceType {
  AGENTS
  WEB
  LABS
  SOLUTIONS
}

enum PlanTier {
  STARTER
  GROWTH
  SCALE
  ENTERPRISE
  CUSTOM
}

model Plan {
  id                    String          @id @default(cuid())
  name                  String
  slug                  String          @unique
  serviceType           PlanServiceType
  tier                  PlanTier
  priceMonthly          Decimal         @db.Decimal(10, 2)
  priceAnnual           Decimal         @db.Decimal(10, 2)
  priceOneTime          Decimal?        @db.Decimal(10, 2)
  features              Json            // Feature list
  limits                Json            // Usage limits (interactions/month, projects, etc.)
  stripeProductId       String?         @unique
  stripePriceIdMonthly  String?         @unique
  stripePriceIdAnnual   String?         @unique
  stripePriceIdOneTime  String?         @unique
  active                Boolean         @default(true)
  displayOrder          Int             @default(0)
  description           String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  subscriptions         Subscription[]

  @@index([serviceType])
  @@index([active])
  @@index([serviceType, active])
  @@map("plans")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  PAUSED
  CANCELED
  TRIALING
  INCOMPLETE
}

enum PaymentStatus {
  ACTIVE
  PAST_DUE
  PAUSED
  CANCELED
}

model Subscription {
  id                    String              @id @default(cuid())
  userId                String
  planId                String
  status                SubscriptionStatus  @default(ACTIVE)
  billingCycle          String              @default("monthly") // "monthly" | "annual"
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean             @default(false)
  canceledAt            DateTime?
  trialStart            DateTime?
  trialEnd              DateTime?

  // Stripe integration
  stripeCustomerId      String?
  stripeSubscriptionId  String?             @unique
  stripePriceId         String?

  // Payment recovery & dunning (PROD-043)
  paymentStatus         PaymentStatus       @default(ACTIVE)
  failedAt              DateTime?
  gracePeriodEnds       DateTime?
  pausedAt              DateTime?
  lastDunningEmail      DateTime?
  dunningEmailCount     Int                 @default(0)

  metadata              Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                  Plan                @relation(fields: [planId], references: [id])
  agentAssignments      AgentAssignment[]
  usageRecords          UsageRecord[]
  aiUsage               AIUsage[]

  @@index([userId])
  @@index([planId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([paymentStatus])
  @@index([userId, status])
  @@index([status, currentPeriodEnd])
  @@map("subscriptions")
}

enum AgentType {
  SDR           // Mike - Sales Development
  RESEARCHER    // Sarah - Research
  SUPPORT       // Alex - Customer Support
  CONTENT       // Casey - Content Creation
  DESIGNER      // LUMEN - Design
  VIDEO         // FLUX - Video Production
}

model AgentAssignment {
  id              String    @id @default(cuid())
  subscriptionId  String
  userId          String
  agentType       AgentType
  agentName       String    // "Mike", "Sarah", "Alex", "Casey", "LUMEN", "FLUX"
  active          Boolean   @default(true)
  configuredAt    DateTime  @default(now())
  customConfig    Json?     // Brand voice, target audience, etc.
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  usageRecords    UsageRecord[]
  aiUsage         AIUsage[]

  @@unique([subscriptionId, agentType])
  @@index([userId])
  @@index([subscriptionId])
  @@index([active])
  @@map("agent_assignments")
}

model UsageRecord {
  id                String    @id @default(cuid())
  subscriptionId    String
  agentAssignmentId String?
  period            String    // "2024-01" (YYYY-MM)
  interactionCount  Int       @default(0)
  tokenUsage        Int       @default(0)
  apiCost           Decimal   @default(0) @db.Decimal(10, 6)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  subscription      Subscription     @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  agentAssignment   AgentAssignment? @relation(fields: [agentAssignmentId], references: [id], onDelete: SetNull)

  @@unique([subscriptionId, period])
  @@index([subscriptionId])
  @@index([agentAssignmentId])
  @@index([period])
  @@map("usage_records")
}

// AI Cost Control & Monitoring (PROD-042)
enum AIModel {
  HAIKU
  SONNET
  OPUS
}

model AIUsage {
  id              String       @id @default(cuid())
  userId          String
  subscriptionId  String?
  agentAssignmentId String?
  employeeType    String       // AgentType as string for flexibility
  model           AIModel
  inputTokens     Int
  outputTokens    Int
  costUSD         Decimal      @db.Decimal(10, 6)
  conversationId  String?
  taskType        String?
  requestData     Json?        // Store request metadata
  createdAt       DateTime     @default(now())

  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  agentAssignment AgentAssignment? @relation(fields: [agentAssignmentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([agentAssignmentId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([subscriptionId, createdAt])
  @@map("ai_usage")
}

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
  PROCESSING
}

model OneTimeOrder {
  id                    String      @id @default(cuid())
  userId                String
  serviceType           PlanServiceType
  projectType           String?     // "landing_page", "web_app", "mvp", etc.
  description           String?
  priceQuoted           Decimal     @db.Decimal(10, 2)
  pricePaid             Decimal?    @db.Decimal(10, 2)
  currency              String      @default("usd")

  // Stripe integration
  stripePaymentIntentId String?     @unique
  stripeInvoiceId       String?

  status                OrderStatus @default(PENDING)
  metadata              Json?
  paidAt                DateTime?
  refundedAt            DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([serviceType])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("one_time_orders")
}

// Real-Time Messaging (PROD-020)
enum ConversationType {
  VALIS_CHAT        // Client chatting with VALIS (AI personality)
  AGENT_CHAT        // Client delegating to AI employee
  ADMIN_CHAT        // Admin-to-client communication
  SUPPORT_TICKET    // Support ticket conversation
}

enum MessageSenderType {
  USER              // Human user (client or admin)
  VALIS             // VALIS AI personality
  AGENT             // AI Employee
  ADMIN             // Human admin
  SYSTEM            // System-generated messages
}

enum MessageContentType {
  TEXT              // Plain text message
  FILE              // File attachment
  IMAGE             // Image attachment
  TASK_RESULT       // AI employee task result
  TASK_ASSIGNMENT   // Task assignment notification
}

model Conversation {
  id              String             @id @default(cuid())
  userId          String             // Primary user (client) in the conversation
  type            ConversationType
  title           String?
  participants    String[]           // Array of user IDs participating
  lastMessageAt   DateTime?
  unreadCount     Int                @default(0)
  metadata        Json?              // Store agentType, ticketId, projectId, etc.
  archived        Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  messages        Message[]

  @@index([userId])
  @@index([type])
  @@index([userId, lastMessageAt])
  @@index([archived])
  @@map("conversations")
}

model Message {
  id              String             @id @default(cuid())
  conversationId  String
  senderId        String?            // Null for system/VALIS messages
  senderType      MessageSenderType
  content         String             // Text content or file description
  contentType     MessageContentType @default(TEXT)
  agentType       String?            // If from AI employee (MIKE, SARAH, etc.)
  fileUrl         String?            // Supabase Storage URL for attachments
  fileName        String?
  fileSize        Int?               // Bytes
  fileMimeType    String?
  metadata        Json?              // Task status, references, etc.
  editedAt        DateTime?
  deletedAt       DateTime?          // Soft delete
  createdAt       DateTime           @default(now())

  conversation    Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([conversationId, createdAt])
  @@index([senderType])
  @@map("messages")
}

// Bulk Announcements (PROD-033)
enum AnnouncementType {
  MAINTENANCE       // System maintenance notice
  FEATURE          // New feature announcement
  NEWS             // General company news
}

enum AnnouncementAudience {
  ALL              // All clients
  ACTIVE           // Active subscription clients only
  INACTIVE         // Inactive/former clients only
}

model Announcement {
  id              String                @id @default(cuid())
  title           String
  content         String
  type            AnnouncementType      @default(NEWS)
  targetAudience  AnnouncementAudience  @default(ALL)
  sentCount       Int                   @default(0)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([createdAt])
  @@index([type])
  @@map("announcements")
}
